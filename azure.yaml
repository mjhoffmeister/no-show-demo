# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

# =============================================================================
# Main Infrastructure: Medical Appointment No-Show Predictor
# =============================================================================
# This handles SQL, ML Workspace, and Static Web App via Terraform
# 
# The hosted agent is deployed separately via infra-agent/ (Bicep)
# See agent/README.md for agent deployment instructions
# =============================================================================

name: no-show-predictor
metadata:
    template: custom
services:
    frontend:
        project: ""
        host: staticwebapp
        language: ""
        dist: ./frontend/src/NoShowPredictor.Web/bin/Release/net10.0/publish/wwwroot
    # Agent service is now handled by separate azd project in infra-agent/
    # This avoids the limitation of mixing Terraform and Bicep providers
infra:
    provider: terraform
    path: infra
hooks:
    postprovision:
        name: postprovision
        shell: pwsh
        run: |
            Write-Host "Infrastructure provisioned successfully"

            # Get Terraform outputs from azd's state location
            $stateFile = ".azure/$env:AZURE_ENV_NAME/infra/terraform.tfstate"
            $outputs = terraform output -json -state="$stateFile" | ConvertFrom-Json

            # Set environment variables for services
            azd env set AZURE_SQL_SERVER "$($outputs.sql_server_fqdn.value)"
            azd env set AZURE_SQL_DATABASE "$($outputs.sql_database_name.value)"
            azd env set AZURE_ML_ENDPOINT_URL "$($outputs.ml_endpoint_url.value)"
            azd env set AZURE_STATIC_WEB_APP_URL "$($outputs.static_web_app_url.value)"

            Write-Host "Environment variables configured:"
            Write-Host "  SQL_SERVER: $($outputs.sql_server_fqdn.value)"
            Write-Host "  SQL_DATABASE: $($outputs.sql_database_name.value)"
            Write-Host "  ML_ENDPOINT_URL: $($outputs.ml_endpoint_url.value)"
            Write-Host "  STATIC_WEB_APP_URL: $($outputs.static_web_app_url.value)"
    prepackage:
        name: prepackage
        shell: pwsh
        run: |
            Write-Host "Building Blazor WebAssembly frontend..."
            dotnet publish frontend/src/NoShowPredictor.Web -c Release
            Write-Host "Frontend build complete"
