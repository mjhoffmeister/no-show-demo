# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: no-show-predictor
metadata:
    template: custom
services:
    frontend:
        project: ""
        host: staticwebapp
        language: ""
        dist: ./frontend/src/NoShowPredictor.Web/bin/Release/net10.0/publish/wwwroot
    noshow-predictor:
        project: src/noshow-predictor
        host: azure.ai.agent
        language: docker
        docker:
            remoteBuild: true
        config:
            container:
                resources:
                    cpu: "1"
                    memory: 2Gi
                scale:
                    maxReplicas: 3
                    minReplicas: 1
            deployments:
                - model:
                    format: OpenAI
                    name: gpt-4o
                    version: "2024-11-20"
                  name: gpt-4o
                  sku:
                    capacity: 30
                    name: Standard
infra:
    provider: terraform
    path: infra
hooks:
    postprovision:
        name: postprovision
        shell: pwsh
        run: |
            Write-Host "Infrastructure provisioned successfully"

            # Get Terraform outputs from azd's state location
            $stateFile = ".azure/$env:AZURE_ENV_NAME/infra/terraform.tfstate"
            $outputs = terraform output -json -state="$stateFile" | ConvertFrom-Json

            # Set environment variables for services (use quotes for values with special chars)
            azd env set AZURE_SQL_SERVER "$($outputs.sql_server_fqdn.value)"
            azd env set AZURE_SQL_DATABASE "$($outputs.sql_database_name.value)"
            azd env set AZURE_ML_ENDPOINT_URL "$($outputs.ml_endpoint_url.value)"
            azd env set AZURE_FOUNDRY_ENDPOINT "$($outputs.foundry_endpoint.value)"
            azd env set AZURE_APPLICATION_INSIGHTS_CONNECTION_STRING "$($outputs.application_insights_connection_string.value)"
            azd env set AZURE_ACR_LOGIN_SERVER "$($outputs.acr_login_server.value)"
            azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT "$($outputs.acr_login_server.value)"
            azd env set AZURE_STATIC_WEB_APP_URL "$($outputs.static_web_app_url.value)"

            Write-Host "Environment variables configured:"
            Write-Host "  SQL_SERVER: $($outputs.sql_server_fqdn.value)"
            Write-Host "  SQL_DATABASE: $($outputs.sql_database_name.value)"
            Write-Host "  ML_ENDPOINT_URL: $($outputs.ml_endpoint_url.value)"
            Write-Host "  AI_FOUNDRY_ENDPOINT: $($outputs.foundry_endpoint.value)"
    predeploy:
        name: predeploy
        shell: pwsh
        run: |
            Write-Host "Preparing for deployment..."
    prepackage:
        name: prepackage
        shell: pwsh
        run: |
            Write-Host "Building Blazor WebAssembly frontend..."
            dotnet publish frontend/src/NoShowPredictor.Web -c Release
            Write-Host "Frontend build complete"
