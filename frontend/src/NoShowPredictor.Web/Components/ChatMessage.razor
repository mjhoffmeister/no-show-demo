@using NoShowPredictor.Web.Models
@using MudBlazor
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components.Rendering

<div class="message-text">
    @if (Message.IsUser)
    {
        <MudText Typo="Typo.body1">@Message.Content</MudText>
    } 
    else
    {
        @RenderFormattedContent(Message.Content ?? "")
    }
</div>

@code {
    /// <summary>
    /// The chat message to display.
    /// </summary>
    [Parameter]
    public required ChatMessageModel Message { get; set; }

    /// <summary>
    /// Event callback when a patient name is clicked for drill-down.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnPatientClick { get; set; }

    /// <summary>
    /// Event callback when an appointment ID is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<int> OnAppointmentClick { get; set; }

    // Regex patterns for detecting content
    private static readonly Regex PriorityPattern = new(@"\*\*(Urgent|High|Medium|Low)\*\*|\b(Urgent|High Priority|Medium Priority|Low Priority)\b", RegexOptions.IgnoreCase | RegexOptions.Compiled);
    private static readonly Regex RiskLevelPattern = new(@"\b(High|Medium|Low)[\s-]*[Rr]isk\b|\b(\d{1,3})%\s*risk\b", RegexOptions.IgnoreCase | RegexOptions.Compiled);
    private static readonly Regex PatientNamePattern = new(@"\*\*([A-Z][a-z]+ [A-Z][a-z]+)\*\*", RegexOptions.Compiled);
    private static readonly Regex ActionTypePattern = new(@"\b(Confirmation Call|Phone Call|Reminder|Overbook|Text Reminder|Email Reminder)\b", RegexOptions.IgnoreCase | RegexOptions.Compiled);
    private static readonly Regex TableRowPattern = new(@"^\|(.+)\|$", RegexOptions.Compiled);
    private static readonly Regex TableSeparatorPattern = new(@"^\|[\s\-:]+\|$", RegexOptions.Compiled);
    private static readonly Regex DayOfWeekPattern = new(@"\b(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\b", RegexOptions.IgnoreCase | RegexOptions.Compiled);

    private RenderFragment RenderFormattedContent(string content)
    {
        return builder =>
        {
            var lines = content.Split('\n');
            var lineIndex = 0;
            var isInTable = false;
            var tableLines = new List<string>();

            foreach (var line in lines)
            {
                var trimmedLine = line.TrimStart();
                
                // Detect markdown table
                if (TableRowPattern.IsMatch(trimmedLine))
                {
                    if (!isInTable)
                    {
                        isInTable = true;
                        tableLines = new List<string>();
                    }
                    tableLines.Add(trimmedLine);
                    continue;
                }
                else if (isInTable && tableLines.Count > 0)
                {
                    // End of table - render it
                    RenderTable(builder, ref lineIndex, tableLines);
                    isInTable = false;
                    tableLines.Clear();
                }
                
                // Check for section headers (## or ###)
                if (trimmedLine.StartsWith("###"))
                {
                    builder.OpenElement(lineIndex++, "h4");
                    builder.AddAttribute(lineIndex++, "class", "mt-3 mb-2");
                    builder.AddContent(lineIndex++, trimmedLine.TrimStart('#').Trim());
                    builder.CloseElement();
                }
                else if (trimmedLine.StartsWith("##"))
                {
                    builder.OpenElement(lineIndex++, "h3");
                    builder.AddAttribute(lineIndex++, "class", "mt-4 mb-2");
                    builder.AddContent(lineIndex++, trimmedLine.TrimStart('#').Trim());
                    builder.CloseElement();
                }
                // Check for bullet points with recommendations
                else if (trimmedLine.StartsWith("- ") || trimmedLine.StartsWith("* "))
                {
                    builder.OpenElement(lineIndex++, "div");
                    builder.AddAttribute(lineIndex++, "class", "recommendation-item d-flex align-center gap-2 my-2");
                    
                    // Add appropriate icon based on content
                    if (ActionTypePattern.IsMatch(trimmedLine))
                    {
                        var iconName = GetActionIcon(trimmedLine);
                        var iconColor = GetPriorityColor(trimmedLine);
                        builder.OpenComponent<MudIcon>(lineIndex++);
                        builder.AddAttribute(lineIndex++, "Icon", iconName);
                        builder.AddAttribute(lineIndex++, "Color", iconColor);
                        builder.AddAttribute(lineIndex++, "Size", Size.Small);
                        builder.CloseComponent();
                    }
                    
                    // Add priority chip if priority is mentioned
                    if (PriorityPattern.IsMatch(trimmedLine))
                    {
                        var priority = ExtractPriority(trimmedLine);
                        builder.OpenComponent<MudChip<string>>(lineIndex++);
                        builder.AddAttribute(lineIndex++, "Size", Size.Small);
                        builder.AddAttribute(lineIndex++, "Color", GetChipColor(priority));
                        builder.AddAttribute(lineIndex++, "Text", priority);
                        builder.CloseComponent();
                    }
                    
                    // Render the content with clickable patient names
                    builder.OpenElement(lineIndex++, "span");
                    RenderLineWithPatientLinks(builder, ref lineIndex, trimmedLine.Substring(2));
                    builder.CloseElement();
                    
                    builder.CloseElement();
                }
                // Check for weekly forecast-style data (day: number pattern)
                else if (DayOfWeekPattern.IsMatch(trimmedLine) && trimmedLine.Contains(":"))
                {
                    RenderForecastDay(builder, ref lineIndex, trimmedLine);
                }
                // Regular paragraph line
                else if (!string.IsNullOrWhiteSpace(line))
                {
                    builder.OpenElement(lineIndex++, "p");
                    builder.AddAttribute(lineIndex++, "class", "my-1");
                    RenderLineWithPatientLinks(builder, ref lineIndex, line);
                    builder.CloseElement();
                }
                else
                {
                    // Empty line - add spacing
                    builder.OpenElement(lineIndex++, "br");
                    builder.CloseElement();
                }
            }

            // Handle case where content ends with table
            if (isInTable && tableLines.Count > 0)
            {
                RenderTable(builder, ref lineIndex, tableLines);
            }
        };
    }

    private void RenderTable(RenderTreeBuilder builder, ref int index, List<string> tableLines)
    {
        // Skip if we don't have at least header + separator + 1 data row
        if (tableLines.Count < 3) return;

        builder.OpenComponent<MudSimpleTable>(index++);
        builder.AddAttribute(index++, "Dense", true);
        builder.AddAttribute(index++, "Hover", true);
        builder.AddAttribute(index++, "Class", "forecast-table my-3");
        builder.AddAttribute(index++, "ChildContent", (RenderFragment)(tableBuilder =>
        {
            var tbi = 0;

            // Render header
            tableBuilder.OpenElement(tbi++, "thead");
            tableBuilder.OpenElement(tbi++, "tr");
            var headerCells = ParseTableRow(tableLines[0]);
            foreach (var cell in headerCells)
            {
                tableBuilder.OpenElement(tbi++, "th");
                tableBuilder.AddContent(tbi++, cell.Trim());
                tableBuilder.CloseElement();
            }
            tableBuilder.CloseElement(); // tr
            tableBuilder.CloseElement(); // thead

            // Render body (skip header and separator lines)
            tableBuilder.OpenElement(tbi++, "tbody");
            for (int i = 2; i < tableLines.Count; i++)
            {
                if (TableSeparatorPattern.IsMatch(tableLines[i])) continue;
                
                var cells = ParseTableRow(tableLines[i]);
                var isHighRisk = IsHighRiskRow(cells);
                
                tableBuilder.OpenElement(tbi++, "tr");
                if (isHighRisk)
                {
                    tableBuilder.AddAttribute(tbi++, "class", "high-risk-row");
                }
                
                for (int j = 0; j < cells.Length; j++)
                {
                    tableBuilder.OpenElement(tbi++, "td");
                    var cellContent = cells[j].Trim();
                    
                    // Add warning icon for high-risk indicators
                    if (isHighRisk && j == 0 && DayOfWeekPattern.IsMatch(cellContent))
                    {
                        tableBuilder.OpenComponent<MudIcon>(tbi++);
                        tableBuilder.AddAttribute(tbi++, "Icon", Icons.Material.Filled.Warning);
                        tableBuilder.AddAttribute(tbi++, "Color", Color.Warning);
                        tableBuilder.AddAttribute(tbi++, "Size", Size.Small);
                        tableBuilder.AddAttribute(tbi++, "Class", "mr-1");
                        tableBuilder.CloseComponent();
                    }
                    
                    // Render percentage with color coding
                    if (cellContent.Contains("%") && Regex.IsMatch(cellContent, @"\d+(\.\d+)?%"))
                    {
                        var percentColor = GetPercentageColor(cellContent);
                        tableBuilder.OpenElement(tbi++, "span");
                        tableBuilder.AddAttribute(tbi++, "style", $"color: {percentColor}; font-weight: 600;");
                        tableBuilder.AddContent(tbi++, cellContent);
                        tableBuilder.CloseElement();
                    }
                    else
                    {
                        tableBuilder.AddContent(tbi++, cellContent);
                    }
                    
                    tableBuilder.CloseElement(); // td
                }
                tableBuilder.CloseElement(); // tr
            }
            tableBuilder.CloseElement(); // tbody
        }));
        builder.CloseComponent();
    }

    private void RenderForecastDay(RenderTreeBuilder builder, ref int index, string line)
    {
        builder.OpenElement(index++, "div");
        builder.AddAttribute(index++, "class", "forecast-day-item d-flex align-center gap-2 my-2 pa-2");
        
        // Parse day and value
        var dayMatch = DayOfWeekPattern.Match(line);
        var isHighRisk = line.Contains("high risk", StringComparison.OrdinalIgnoreCase) ||
                        line.Contains("⚠", StringComparison.OrdinalIgnoreCase) ||
                        (Regex.IsMatch(line, @"(\d{2,3})%") && int.TryParse(Regex.Match(line, @"(\d{2,3})%").Groups[1].Value, out var pct) && pct >= 30);

        if (isHighRisk)
        {
            builder.AddAttribute(index++, "style", "background: rgba(255, 152, 0, 0.1); border-left: 3px solid #ff9800;");
            builder.OpenComponent<MudIcon>(index++);
            builder.AddAttribute(index++, "Icon", Icons.Material.Filled.Warning);
            builder.AddAttribute(index++, "Color", Color.Warning);
            builder.AddAttribute(index++, "Size", Size.Small);
            builder.CloseComponent();
        }
        else
        {
            builder.OpenComponent<MudIcon>(index++);
            builder.AddAttribute(index++, "Icon", Icons.Material.Filled.Event);
            builder.AddAttribute(index++, "Color", Color.Default);
            builder.AddAttribute(index++, "Size", Size.Small);
            builder.CloseComponent();
        }

        builder.OpenElement(index++, "span");
        RenderLineWithPatientLinks(builder, ref index, line);
        builder.CloseElement();
        
        builder.CloseElement();
    }

    private static string[] ParseTableRow(string row)
    {
        // Remove leading/trailing pipes and split by |
        return row.Trim('|').Split('|');
    }

    private static bool IsHighRiskRow(string[] cells)
    {
        foreach (var cell in cells)
        {
            // Check for high percentage (>30%)
            if (Regex.IsMatch(cell, @"(\d{2,3})%"))
            {
                var match = Regex.Match(cell, @"(\d+)%");
                if (match.Success && int.TryParse(match.Groups[1].Value, out var percentage))
                {
                    if (percentage >= 30) return true;
                }
            }
            // Check for risk indicator text
            if (cell.Contains("high", StringComparison.OrdinalIgnoreCase) && 
                cell.Contains("risk", StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }
            // Check for warning symbol
            if (cell.Contains("⚠") || cell.Contains("!"))
            {
                return true;
            }
        }
        return false;
    }

    private static string GetPercentageColor(string text)
    {
        var match = Regex.Match(text, @"(\d+(\.\d+)?)%");
        if (match.Success && double.TryParse(match.Groups[1].Value, out var percentage))
        {
            return percentage switch
            {
                >= 40 => "#d32f2f", // Red - very high risk
                >= 30 => "#f57c00", // Orange - high risk
                >= 20 => "#fbc02d", // Yellow/Amber - moderate risk
                _ => "#388e3c"      // Green - normal
            };
        }
        return "inherit";
    }

    private void RenderLineWithPatientLinks(RenderTreeBuilder builder, ref int index, string text)
    {
        var matches = PatientNamePattern.Matches(text);
        var lastIndex = 0;

        foreach (Match match in matches)
        {
            // Add text before the match
            if (match.Index > lastIndex)
            {
                builder.AddContent(index++, text.Substring(lastIndex, match.Index - lastIndex).Replace("**", ""));
            }

            // Add clickable patient name
            var patientName = match.Groups[1].Value;
            builder.OpenComponent<MudLink>(index++);
            builder.AddAttribute(index++, "Href", "#");
            builder.AddAttribute(index++, "OnClick", EventCallback.Factory.Create<MouseEventArgs>(this, () => HandlePatientClick(patientName)));
            builder.AddAttribute(index++, "Class", "patient-link");
            builder.AddAttribute(index++, "ChildContent", (RenderFragment)(b => b.AddContent(0, patientName)));
            builder.CloseComponent();

            lastIndex = match.Index + match.Length;
        }

        // Add remaining text
        if (lastIndex < text.Length)
        {
            builder.AddContent(index++, text.Substring(lastIndex).Replace("**", ""));
        }
    }

    private async Task HandlePatientClick(string patientName)
    {
        if (OnPatientClick.HasDelegate)
        {
            await OnPatientClick.InvokeAsync(patientName);
        }
    }

    private static string GetActionIcon(string text)
    {
        if (text.Contains("Call", StringComparison.OrdinalIgnoreCase) || 
            text.Contains("Phone", StringComparison.OrdinalIgnoreCase))
            return Icons.Material.Filled.Phone;
        if (text.Contains("Reminder", StringComparison.OrdinalIgnoreCase) ||
            text.Contains("Text", StringComparison.OrdinalIgnoreCase))
            return Icons.Material.Filled.Sms;
        if (text.Contains("Email", StringComparison.OrdinalIgnoreCase))
            return Icons.Material.Filled.Email;
        if (text.Contains("Overbook", StringComparison.OrdinalIgnoreCase))
            return Icons.Material.Filled.EventRepeat;
        return Icons.Material.Filled.CheckCircle;
    }

    private static Color GetPriorityColor(string text)
    {
        if (text.Contains("Urgent", StringComparison.OrdinalIgnoreCase))
            return Color.Error;
        if (text.Contains("High", StringComparison.OrdinalIgnoreCase))
            return Color.Warning;
        if (text.Contains("Medium", StringComparison.OrdinalIgnoreCase))
            return Color.Info;
        return Color.Default;
    }

    private static string ExtractPriority(string text)
    {
        var match = PriorityPattern.Match(text);
        if (match.Success)
        {
            var captured = match.Groups[1].Success ? match.Groups[1].Value : match.Groups[2].Value;
            return captured.Split(' ')[0]; // Get first word (Urgent, High, Medium, Low)
        }
        return "Normal";
    }

    private static Color GetChipColor(string priority)
    {
        return priority.ToLowerInvariant() switch
        {
            "urgent" => Color.Error,
            "high" => Color.Warning,
            "medium" => Color.Info,
            "low" => Color.Success,
            _ => Color.Default
        };
    }
}

<style>
    .message-text {
        line-height: 1.6;
    }

    .message-text p {
        margin: 0 0 1em 0;
    }

    .message-text p:last-child {
        margin-bottom: 0;
    }

    .message-text h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 1.5em 0 0.75em 0;
        color: var(--mud-palette-text-primary);
    }

    .message-text h4 {
        font-size: 1rem;
        font-weight: 600;
        margin: 1.25em 0 0.5em 0;
        color: var(--mud-palette-text-primary);
    }

    .recommendation-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 8px 12px;
        margin: 8px 0;
        border-radius: 8px;
        background: var(--mud-palette-background-gray);
    }

    .patient-link {
        font-weight: 600;
        color: var(--mud-palette-primary);
        cursor: pointer;
        text-decoration: none;
    }

    .patient-link:hover {
        text-decoration: underline;
    }

    .forecast-table {
        border-radius: 8px;
        overflow: hidden;
        margin: 16px 0;
    }

    .forecast-table th {
        background-color: var(--mud-palette-primary) !important;
        color: white !important;
        font-weight: 600;
        padding: 12px 16px !important;
    }

    .forecast-table td {
        padding: 10px 16px !important;
        border-bottom: 1px solid var(--mud-palette-divider);
    }

    .high-risk-row {
        background-color: rgba(255, 152, 0, 0.1) !important;
    }

    .forecast-day-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        margin: 6px 0;
        border-radius: 8px;
        background: var(--mud-palette-background-gray);
    }
</style>
