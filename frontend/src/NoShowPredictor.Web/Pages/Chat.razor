@page "/chat"
@attribute [Authorize]
@using NoShowPredictor.Web.Models
@using NoShowPredictor.Web.Services
@using NoShowPredictor.Web.Components
@using NoShowPredictor.Web.Layout
@inject IAgentApiClient AgentClient
@inject IJSRuntime JS

<PageTitle>No-Show Predictor</PageTitle>

<div class="chat-page">
    @* Title bar with actions *@
    <div class="title-bar">
        <MudTooltip Text="New chat">
            <MudIconButton Icon="@Icons.Material.Filled.Add" 
                           Color="Color.Inherit" 
                           OnClick="ClearConversation"
                           Disabled="@(!_messages.Any())" />
        </MudTooltip>
        <div class="title-center">
            <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Small" Class="title-icon" />
            <MudText Typo="Typo.subtitle1" Class="title-text">No-Show Predictor</MudText>
        </div>
        <MudTooltip Text="@(Layout?.IsDarkMode == true ? "Light mode" : "Dark mode")">
            <MudIconButton Icon="@(Layout?.IsDarkMode == true ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                           Color="Color.Inherit"
                           OnClick="ToggleTheme" />
        </MudTooltip>
    </div>

    @* Messages area *@
    <div class="messages-area" @ref="_messagesContainer">
        @if (!_messages.Any())
        {
            <div class="welcome-container">
                <MudText Typo="Typo.h4" Class="welcome-title">No-Show Predictor</MudText>
                <div class="suggestions-grid">
                    <div class="suggestion-card" @onclick="@(() => SendSuggestion("Which patients are at risk of missing their appointments tomorrow?"))">
                        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="suggestion-icon" />
                        <span>High-risk appointments tomorrow</span>
                    </div>
                    <div class="suggestion-card" @onclick="@(() => SendSuggestion("What scheduling actions should I take for tomorrow?"))">
                        <MudIcon Icon="@Icons.Material.Filled.EventNote" Size="Size.Small" Class="suggestion-icon" />
                        <span>Scheduling recommendations</span>
                    </div>
                    <div class="suggestion-card" @onclick="@(() => SendSuggestion("What does the no-show forecast look like for this week?"))">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" Class="suggestion-icon" />
                        <span>Weekly no-show forecast</span>
                    </div>
                    <div class="suggestion-card" @onclick="@(() => SendSuggestion("Show me patients with the highest no-show history"))">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="suggestion-icon" />
                        <span>Patients with high no-show rates</span>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="messages-list">
                @foreach (var msg in _messages)
                {
                    <div class="message-row @(msg.IsUser ? "user" : "assistant")">
                        <div class="message-avatar">
                            @if (msg.IsUser)
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Primary">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                </MudAvatar>
                            }
                            else
                            {
                                <MudAvatar Size="Size.Small" Color="Color.Success">
                                    <MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="Size.Small" />
                                </MudAvatar>
                            }
                        </div>
                        <div class="message-content">
                            @if (msg.IsLoading)
                            {
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            }
                            else if (msg.HasError)
                            {
                                <MudAlert Severity="Severity.Error" Dense="true">@msg.Error</MudAlert>
                            }
                            else
                            {
                                <ChatMessage Message="@msg" 
                                             OnAppointmentClick="HandleAppointmentClick" 
                                             OnPatientClick="HandlePatientClick" />
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    @* Input area *@
    <div class="input-area">
        <div class="input-container">
            <MudTextField @bind-Value="_currentMessage"
                          Placeholder="Message No-Show Predictor..."
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Immediate="true"
                          OnKeyUp="HandleKeyUp"
                          Disabled="@_isLoading"
                          Lines="1"
                          Class="chat-input" />
            <MudIconButton Icon="@Icons.Material.Filled.Send"
                           Color="Color.Primary"
                           OnClick="SendMessage"
                           Disabled="@(_isLoading || string.IsNullOrWhiteSpace(_currentMessage))"
                           Class="send-btn" />
        </div>
        <MudText Typo="Typo.caption" Class="input-disclaimer">
            AI predictions are for guidance only. Always verify with clinical judgment.
        </MudText>
    </div>
</div>

@code {
    [CascadingParameter]
    public MainLayout? Layout { get; set; }
    
    private readonly List<ChatMessageModel> _messages = new();
    private string? _conversationId;
    private string _currentMessage = string.Empty;
    private bool _isLoading;
    private ElementReference _messagesContainer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_messages.Any())
        {
            await ScrollToBottom();
        }
    }

    private void ToggleTheme()
    {
        Layout?.ToggleDarkMode();
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_currentMessage) || _isLoading)
            return;

        var userMessage = _currentMessage.Trim();
        _currentMessage = string.Empty;

        _messages.Add(new ChatMessageModel
        {
            Role = Models.ChatRole.User,
            Content = userMessage,
            Timestamp = DateTime.Now
        });

        var loadingMessage = new ChatMessageModel
        {
            Role = Models.ChatRole.Assistant,
            IsLoading = true,
            Timestamp = DateTime.Now
        };
        _messages.Add(loadingMessage);

        _isLoading = true;
        StateHasChanged();
        await ScrollToBottom();

        try
        {
            var request = new ChatRequest
            {
                Message = userMessage,
                ConversationId = _conversationId
            };
            var response = await AgentClient.SendChatMessageAsync(request);
            _conversationId = response.ConversationId;

            loadingMessage.IsLoading = false;
            loadingMessage.Content = response.Response;
            loadingMessage.Timestamp = DateTime.Now;
        }
        catch (Exception ex)
        {
            loadingMessage.IsLoading = false;
            loadingMessage.Error = "Sorry, I encountered an error. Please try again.";
            Console.Error.WriteLine($"Chat error: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
            await ScrollToBottom();
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private async Task SendSuggestion(string suggestion)
    {
        _currentMessage = suggestion;
        await SendMessage();
    }

    private void ClearConversation()
    {
        _messages.Clear();
        _conversationId = null;
        StateHasChanged();
    }

    private async Task HandleAppointmentClick(int appointmentId)
    {
        _currentMessage = $"Tell me more about appointment #{appointmentId}";
        await SendMessage();
    }

    private async Task HandlePatientClick(string patientName)
    {
        _currentMessage = $"Tell me about {patientName}'s appointment history and no-show risk factors";
        await SendMessage();
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await Task.Delay(50);
            await JS.InvokeVoidAsync("eval", "document.querySelector('.messages-area')?.scrollTo({top: document.querySelector('.messages-area')?.scrollHeight, behavior: 'smooth'})");
        }
        catch { }
    }
}

<style>
    .chat-page {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        background: var(--mud-palette-background);
        position: relative;
    }

    .title-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 16px;
        background: var(--mud-palette-surface);
        border-bottom: 1px solid var(--mud-palette-divider);
        position: relative;
    }

    .title-center {
        display: flex;
        align-items: center;
        gap: 8px;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
    }

    .title-icon {
        color: var(--mud-palette-primary);
    }

    .title-text {
        font-weight: 600;
        color: var(--mud-palette-text-primary);
    }

    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 0;
    }

    .welcome-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 24px;
        text-align: center;
    }

    .welcome-title {
        font-weight: 600;
        margin-bottom: 32px;
        color: var(--mud-palette-text-primary);
    }

    .suggestions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        max-width: 600px;
        width: 100%;
    }

    .suggestion-card {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        border: 1px solid var(--mud-palette-divider);
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.2s ease;
        text-align: left;
        background: var(--mud-palette-surface);
    }

    .suggestion-card:hover {
        background: var(--mud-palette-action-default-hover);
    }

    .suggestion-icon {
        color: var(--mud-palette-text-secondary);
        flex-shrink: 0;
        margin-top: 2px;
    }

    .suggestion-card span {
        color: var(--mud-palette-text-primary);
        font-size: 0.875rem;
        line-height: 1.4;
    }

    .messages-list {
        max-width: 768px;
        margin: 0 auto;
        padding: 24px;
    }

    .message-row {
        display: flex;
        gap: 16px;
        padding: 24px 0;
    }

    .message-row.user {
        background: transparent;
    }

    .message-row.assistant {
        background: var(--mud-palette-surface);
        border-radius: 12px;
        margin: 8px 0;
        padding: 24px;
    }

    .message-avatar {
        flex-shrink: 0;
    }

    .message-content {
        flex: 1;
        min-width: 0;
        overflow-wrap: break-word;
    }

    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--mud-palette-text-secondary);
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @@keyframes typing {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-4px); opacity: 1; }
    }

    .input-area {
        padding: 16px 24px 24px;
        background: var(--mud-palette-background);
    }

    .input-container {
        display: flex;
        gap: 8px;
        max-width: 768px;
        margin: 0 auto;
        background: var(--mud-palette-surface);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 12px;
        padding: 8px 8px 8px 16px;
        align-items: center;
    }

    .chat-input {
        flex: 1;
    }

    .chat-input .mud-input-outlined-border {
        border: none !important;
    }

    .chat-input .mud-input {
        margin: 0 !important;
    }

    .send-btn {
        flex-shrink: 0;
    }

    .input-disclaimer {
        text-align: center;
        color: var(--mud-palette-text-secondary);
        margin-top: 12px;
        font-size: 0.75rem;
        width: 100%;
        display: block;
    }

    @@media (max-width: 600px) {
        .suggestions-grid {
            grid-template-columns: 1fr;
        }

        .messages-list {
            padding: 16px;
        }

        .message-row.assistant {
            margin: 8px 0;
            padding: 16px;
        }
    }
</style>
